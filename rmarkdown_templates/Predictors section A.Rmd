---
title: "Predictors section A"
author: "Shubila Balaile"
date: '2021-02-15'
output: 
      html_document:
        toc : yes
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,output_file = "Predictors section A.html", output_dir = "../paper") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(sjlabelled)
library(descr)
library(summarytools)
library(kableExtra)
library(sjPlot)

```

#### Possible predictors 

<div style="margin-bottom:40px;">
This is an exercise in investigating the variables in our dataset for possible predictors.   
The purpose is to determine which variables that are straightforward to use, which ones could be used with some adjustments and which ones cannot be used at all (if for example questions are directed to a too small subset of respondents).  
An important task is to, by using Silvijas mapping of variables from previous research, look at the status (i.e is the variable easy to implement in analysis or not)  of the variables which can be used for comparisons with previous studies.
</div>

```{r load_data, warning = FALSE}

############# load_data  ###########################

# In order to make life easier from a coding perspective I use both datasets (stata, and spss)
# in different situations since one of them is predominantly numeric in format (.dta) and the other is 
# formated predominantly as a dataset with factors. In some situations it is easier with one over the other.

lgbti_sav <- readRDS("../data/clean/lgbti_sav.rds")

lgbti_dta <- readRDS("C:/Users/shubi/Documents/IPSDS/Thesis/LGBTI/data/clean/lgbti_dta.rds")

# extract variabel labels from the dta dataset and put them into a char vector.

var_labs <- map_chr(lgbti_dta, ~ label(.))

var_labs_a <- var_labs[str_detect(names(var_labs),"^A")]

vars_section_a <- c("RESPONDENT_CATEGORY", names(var_labs_a))


```

#### Section A predictors 

Section A  deals with the screening and introduction of the questionnaire.  

#####  Table 1.

<div style="margin-bottom:40px;">
`r view_df(lgbti_dta[vars_section_a])$knitr`
</div>

<div style="margin-bottom:40px;">  
Questions A3 to A6_1 (variables 4-8) concerns determination of which LGBTI category (if any) the respondent belongs to.   
The outcome of these are derived into the variable "RESPONDENT_CATEGORY".   
Thus for the purpose of analysis questions A3 to A6_1 are dropped and "RESPONDENT_CATEGORY" is used in their place.   
All other questions, except for A13 and A14, in section A are asked to all respondents and are single response questions, making them "straightforward" to include in the analysis.   
This leaves us with the predictors from section A shown in table "section_a" below.
</div>

<div style="margin-bottom:20px;"> 
```{r var_list_a, warning = FALSE}


################  var_list_a ################################

section_a_variables <-
  c(
    "RESPONDENT_CATEGORY",
    "A1",
    "A2",
    "A7",
    "A8",
    "A10",
    "A10_1",
    "A11",
    "A11_1",
    "A13",
    "A14"
  )

section_a <- lgbti_dta %>%
  filter(!is.na(open_at_work)) %>%
  select(all_of(section_a_variables))

dfsummary_a <-
  dfSummary(
    section_a,
    graph.magnif = 0.75,
    graph.col = FALSE,
    plain.ascii = FALSE,
    labels.col = TRUE,
    varnumbers = TRUE,
    na.col = FALSE,
    split.cells = 20,
    headings = TRUE,
    footnote = NA
  )

dfsummary_a$`Stats / Values` <- NULL


print(dfsummary_a,
      method = 'render')


```
</div>

<div style="margin-bottom:20px;"> 
The table, "section_a", is generated from the stata dataset (.dta), which uses only numeric variables.   However most variables are in fact categorical and for those the numerical values represent categories(with labels as is done in SPSS).   
In my view it is easier to use the stata dataset to see which variables are "truly" numeric or not.  
From the table we see that all variables are categorical except for:  
  
* A13("	How old were you when you realised for the first time you are {RESPONDENT_CATEGORY}")   
* A14 ("How old were you when you first told somebody you are {RESPONDENT_CATEGORY}").  
  
Given that the dataset has few numerical variables these two are important.  
However, if we look at Table 1 under the heading "Section A predictors" we note that for variable A14 there is the number -998, which means "I have not told anybody".  
If this is a large group then I don't think we can use this variable as numeric because this would mean discarding a big number of observations.  
Furthermore: not everyone answered questions A13 and A14, there are skip instructions in the questionnaire which means that only those who answered 1-3 on A4 get to answer A13 and A14.  
As indicated by the instruction this means that only the LGB population got these last two questions of section A.  
But this is were things get quite confusing. When I crosstabulate A13 and A14 with RESPONDENT_CATEGORY I get the following results:
</div>

#####  Table 2.
```{r a13_14, warning = FALSE}

# Recode A13 and A14 from numeric to factor to cross check NA:s in relation to our dependent variable 

A13_A14_fct <-
  inner_join(lgbti_dta, lgbti_sav, by = "RESPONDENT_ID") %>%
  filter(!is.na(open_at_work.x))%>%
select(
  A13.x,
  A14.x,
  open_at_work.x,
  open_at_work.y,
  RESPONDENT_CATEGORY.y,
  RESPONDENT_CATEGORY.x,
  A3.y,
  A3.x,
  A4.x,
  A4.y
) %>%
  mutate(A13_fct = as.factor(case_when(A13.x > 0  ~ ">0",
                                       TRUE  ~ as.character(A13.x))),
         A14_fct = as.factor(case_when(A14.x > 0  ~ ">0",
                                       TRUE  ~ as.character(A14.x))))
         
print(
  ctable(
    y = A13_A14_fct$A13_fct,
    x = A13_A14_fct$RESPONDENT_CATEGORY.y ,
    useNA = "ifany",
    prop = "n"
  ),
  big.mark = " ",
  decimal.mark = ".",
  method = "render"
)

print(
  ctable(
    y = A13_A14_fct$A14_fct,
    x = A13_A14_fct$RESPONDENT_CATEGORY.y,
    useNA = "ifany",
    prop = "n"
  ),
  big.mark = " ",
  decimal.mark = ".",
  method = "render"
)

c_tab_a13 <- as.matrix(table(A13_A14_fct$A13_fct,A13_A14_fct$RESPONDENT_CATEGORY.y,useNA = "ifany"))

# intersex_na_a13 <- c_tab_a13[">0","intersex"]
# trans_na_a13    <- c_tab_a13[">0","trans"]

c_tab_a14 <- as.matrix(table(A13_A14_fct$A14_fct,A13_A14_fct$RESPONDENT_CATEGORY.y,useNA = "ifany"))

# intersex_na_a14 <- c_tab_a14[">0","intersex"]
# trans_na_a14    <- c_tab_a14[">0","trans"]



```

In the two crosstabulations above I have filtered out the population that we are interested in (those who answered "open_at_work"). 
Then I created factors for each one of the numerical variables A13 and A14.     

The categories for the factors are:
  
"-2"   = "Not applicable"  
"-999" = "Don't know"  
"-998" = "I have not told anybody"  
">0"   = numerical value above 0    

The first observation I make is that for the variable A14 we will have a hard time using it as a numeric variable.  
In the A14 cross tabulation the column "-998" shows respondents who cannot give a numeric answer because they have never told anyone about being LGBTI. 
The rowsum total for this column is 4192 which is not negligible.  
From this I conclude that we should not use it as a numerical variable (we would loose an important group and reduce our observations).  
An option might be to convert the variable into a categorical one with the same age groups as the age variable and adding the group who never told anyone as a category?

Looking at the cross tabulation for A13 we see that `r c_tab_a13[">0","intersex"]` and `r c_tab_a13[">0","trans"]` persons who are categorized as `r colnames(c_tab_a13)[apply(c_tab_a13, MARGIN = 2, function(a) any(a == c_tab_a13[">0","intersex"]))]` and `r colnames(c_tab_a13)[apply(c_tab_a13, MARGIN = 2, function(a) any(a == c_tab_a13[">0","trans"]))]` respectively for the variable "RESPONDENT_CATEGORY" answered A13.  
This is confusing since the fact that a majority of respondents who are categorized as intersex and trans __did__ answer A13 and this seems to contradict the skipping instruction which says that the questions are supposed to be answered by the LGB population only. 
Then adding to the confusion, looking in the column "-2" we see that a sizable number of respondents who are intersex and trans __did not__ answer A13.  
To understand this (or at least try) I made further cross tabulations:

#####  Table 3.
```{r a13_14_A3_A4, warning = FALSE}

trans_inter <- A13_A14_fct %>%
  filter(RESPONDENT_CATEGORY.y %in% c("intersex","trans") & 
        (A13_fct == "-2"|A13_fct == ">0")
         )%>% droplevels()


print(
stby(list(x = trans_inter$RESPONDENT_CATEGORY.y, y = trans_inter$A4.y), 
     INDICES = list(trans_inter$A13_fct), FUN = ctable,useNA = "ifany",
     prop = "n"),
  big.mark = " ",
  decimal.mark = ".",
  method = "render"
)




```
<div style="margin-bottom:40px;">
By first filtering out only the trans and intersex categories of the RESPONDENT_CATEGORY variable and then  cross tabulating three variables, A13 x RESPONDENT_CATEGORY x A4, we get the answer to the confusion above:  
From crossing the 3 variables we see that in the first table we are only looking at respondents who did not answer A13. These respondents answered 4 or 5 (with the exception of some anomalies) on A4.  
Those who did answer A13(second table) answered 1-3 on A4.   
The conclusion is that if we want to use the A13 variable, thus discarding the NA:s, we would be taking away all those who ended up being categorized as trans and at the same time are heterosexual or other.  
In magnitude this group is not very big (3837) but they are probably different from other intersex/trans who are LGB for sexual orientation.  
The way I see this is that FRA must have had good reasons for creating this skip pattern so for me it would not be a problem to drop observations in order to use such an important variable.   
It is both a theoretically important variable and it is numeric which we have very few of.  
I think numerical variables might help stabilize the estimations of the algorithms.  
To be discussed......
</div>


#####  Summary

<div style="margin-bottom:40px;">

* Most variables in Section A are straightforward to implement in our analysis. 
* RESPONDENT_CATEGORY is the variable indicating respondents classification into the categories LGBTI and it is derived from the answers of variables A3 to A6_1. Should we use RESPONDENT_CATEGORY or some combination of A3 to A6_1?. The variable RESPONDENT_CATEGORY is important because it reflects the view of FRA on the respondents classification. At the same time Silvija has identified several variables of the A3 to A6_1 from previous studies. Not sure what to think?  
* There are two numerical variables, A13 and A14. A13 asks at what age respondents realized that they are LGBTI. A14 asks respondents at what age they told someone else for the first time that they are LGBTI. Both these variables are in principle numeric. This makes them very important because we do not have many numerical variables in the dataset. However. A group of respondents(4192) answered in A14 that they never told anyone else, thus not giving a numerical answer. In order to use this variable we should convert it to a categorical variable (the group of respondents who answered that they never told anyone is maybe not very big but is surely very important for our research question  by being different from other respondents)? If we want to use A13 we will have to delete 3837 observations of trans and intersex persons who never answered the question because on A4 they answered "heterosexual" or "other". For me it is more important to use the variable than keeping these respondents in our analysis. 
</div>

```{r,ref.label=knitr::all_labels(),echo=TRUE, eval=FALSE}

```

